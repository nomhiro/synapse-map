# CosmosDB パーティションキー設計

## 概要

AI Brainstorming Systemでは、セッション情報とメッセージデータを効率的に格納するため、適切なパーティションキー設計が重要です。

## データアクセスパターン分析

### 主要なクエリパターン

1. **セッション単位でのデータ取得** (最頻繁)
   - 特定セッションの全メッセージ取得
   - セッション詳細情報の取得

2. **時系列でのセッション検索**
   - 最新のセッション一覧
   - 日付範囲でのセッション検索

3. **エージェント別分析**
   - 特定エージェントのメッセージ履歴
   - エージェント別パフォーマンス分析

## パーティションキー設計案

### 推奨案：`/session_id` (セッションID)

```json
{
  "id": "session_20250717_210000_12345",
  "session_id": "session_20250717_210000_12345",  // パーティションキー
  "type": "session",
  ...
}

{
  "id": "session_20250717_210000_12345_msg_1",
  "session_id": "session_20250717_210000_12345",  // パーティションキー
  "type": "message", 
  ...
}
```

#### 利点
- **セッション単位のデータ取得が効率的**
- **同一セッションのデータが同じパーティションに配置**
- **クロスパーティションクエリが不要**
- **スケーラビリティが高い**

#### 欠点
- 時系列クエリでクロスパーティションクエリが必要

### 代替案1：`/date_partition` (日付パーティション)

```json
{
  "id": "session_20250717_210000_12345",
  "date_partition": "2025-07-17",  // パーティションキー
  "session_id": "session_20250717_210000_12345",
  "type": "session",
  ...
}
```

#### 利点
- 日付範囲でのクエリが効率的
- 日次バックアップやアーカイブが容易

#### 欠点
- セッション単位でのクエリでパフォーマンス低下
- 同一日に多数セッションがある場合のホットパーティション

### 代替案2：`/user_session` (ユーザー+セッション)

```json
{
  "id": "session_20250717_210000_12345",
  "user_session": "default_session_20250717_210000_12345",  // パーティションキー
  "session_id": "session_20250717_210000_12345",
  "type": "session",
  ...
}
```

#### 利点
- 将来のマルチユーザー対応に有利
- ユーザー別データ分離

#### 欠点
- 現在はシングルユーザーのため不要な複雑化

## 最終推奨設計

### パーティションキー：`/session_id`

#### 理由
1. **主要アクセスパターンに最適**：セッション単位でのデータ取得が最頻繁
2. **パフォーマンス重視**：同一セッションデータが同じパーティションに配置
3. **シンプルな設計**：現在の要件に最適化
4. **将来拡張性**：必要に応じて後でパーティション戦略を変更可能

### コンテナ設計

```json
{
  "containerName": "chat_sessions",
  "partitionKey": {
    "paths": ["/session_id"],
    "kind": "Hash"
  },
  "indexingPolicy": {
    "indexingMode": "consistent",
    "includedPaths": [
      {
        "path": "/*"
      }
    ],
    "excludedPaths": [
      {
        "path": "/content/*"  // メッセージ内容はインデックス除外
      }
    ]
  },
  "throughput": 400  // 初期RU設定
}
```

### データ構造の最適化

#### セッションドキュメント
```json
{
  "id": "session_20250717_210000_12345",
  "session_id": "session_20250717_210000_12345",  // パーティションキー
  "type": "session",
  "date": "2025-07-17",              // 日付検索用
  "timestamp": 1721246400000,        // Unix timestamp検索用
  "task": "...",
  "status": "completed",
  "team_info": {...},
  "statistics": {...},
  "created_at": "2025-07-17 21:00:00.000",
  "updated_at": "2025-07-17 21:15:30.500",
  "ttl": -1  // Time To Live (無期限)
}
```

#### メッセージドキュメント
```json
{
  "id": "session_20250717_210000_12345_msg_1",
  "session_id": "session_20250717_210000_12345",  // パーティションキー
  "type": "message",
  "source": "creative_planner",
  "content": "...",
  "message_type": "TextMessage",
  "timestamp": "2025-07-17 21:00:15.123",
  "sequence": 1,  // メッセージ順序
  "created_at": "2025-07-17 21:00:15.123",
  "ttl": -1
}
```

## クエリ最適化

### 効率的なクエリ例

#### 1. セッション内全メッセージ取得
```sql
SELECT * FROM c 
WHERE c.session_id = "session_20250717_210000_12345"
AND c.type = "message"
ORDER BY c.sequence
```

#### 2. セッション詳細取得
```sql
SELECT * FROM c 
WHERE c.session_id = "session_20250717_210000_12345"
AND c.type = "session"
```

#### 3. 最新セッション一覧（クロスパーティション）
```sql
SELECT * FROM c 
WHERE c.type = "session"
ORDER BY c.timestamp DESC
OFFSET 0 LIMIT 10
```

## パフォーマンス考慮事項

### Request Units (RU) 見積もり

- **セッション作成**: 5-10 RU
- **メッセージ作成**: 5-8 RU
- **セッション読み取り**: 1-2 RU
- **メッセージ一覧読み取り**: 2-5 RU/件

### 初期設定推奨値

- **Throughput**: 400 RU/s (手動)
- **Storage**: 無制限
- **Consistency Level**: Session

## 実装での注意点

### 1. セッションID生成戦略
```python
session_id = f"session_{datetime.now().strftime('%Y%m%d_%H%M%S')}_{uuid.uuid4().hex[:8]}"
```

### 2. メッセージID生成戦略
```python
message_id = f"{session_id}_msg_{sequence_number:04d}"
```

### 3. バッチ処理対応
- 同一セッションのメッセージは高速
- 複数セッションをまたぐ場合はクロスパーティションクエリ

## スケーリング戦略

### 短期（1-6ヶ月）
- 400-1000 RU/s
- 単一リージョン

### 中期（6-18ヶ月）
- 自動スケーリング対応
- 読み取りレプリカ追加検討

### 長期（18ヶ月以降）
- マルチリージョン対応
- アーカイブ戦略実装
- パーティション分割見直し

## 監視指標

- **RU消費量**
- **パーティション分散状況**
- **クエリ実行時間**
- **ストレージ使用量**
- **スロットリング発生頻度**

## まとめ

`/session_id` をパーティションキーとすることで、主要なアクセスパターンに最適化された設計となります。この設計により、セッション単位でのデータ取得が高速化され、システム全体のパフォーマンスが向上します。